<meta charset="utf8" />
<html>
<script src='../dist/sql-wasm-debug.js'></script>
<script>
  const log = (functionName, text, outputId = 'output') => document.getElementById(outputId).insertAdjacentHTML('beforeend', `${functionName ? `<b>${functionName}:</b> ` : ''}${text}<br />`);
  const config = {
    locateFile: (filename, prefix) => {
      return `../dist/${filename}`;
    }
  };
  const timer = () => {
    const start = new Date();
    return {
      stop: () => {
        const end  = new Date();
        return end.getTime() - start.getTime();
      }
    }
  };

  let globalBenchmark;
  let db;

  async function runBenchmark(db) {
    var bench = timer();
      for (let i = 0; i < 250; i++) {
        db.run("INSERT INTO test VALUES (?,?), (?,?), (?,?), (?,?)", [
          'hello',
          'world',
          Math.random(),
          Math.random(),
          1,
          2,
          new Uint8Array(50),
          new Uint8Array(25)
        ]);
      }
      log('db.run', `Took ${bench.stop()}ms to add 1000 entries using`);

      var bench = timer();
      console.log(db.exec('SELECT * FROM test;'));
      log('db.exec', `Took ${bench.stop()}ms to get the rows in the test table`);

      var bench = timer();
      await db.saveChanges();
      log('db.saveChanges', `Took ${bench.stop()}ms to save the changes`);

      // Prepare a statement
      var bench = timer();
      const statement = db.prepare('SELECT * FROM test');
      while (statement.step()) {
        const row = statement.getAsObject();
        //console.log('Found a row: ' + JSON.stringify(row));
      }
      log('db.prepare', `Took ${bench.stop()}ms to get the rows in the test table`);
      log(undefined, '');

      globalBenchmark = setTimeout(async () => await runBenchmark(db), 2000);
  }

  async function main() {
    // We must specify this locateFile function if we are loading a wasm file from anywhere other than the current html page's folder.
    var bench = timer();
    db = new (await sqleet(config))({key: 'supersecurepassword'}, 'aaaaa');
    log('constructor', `Took ${bench.stop()}ms to call the constructor`, 'main_output');

    var bench = timer();
    await db.mount();
    log('db.mount', `Took ${bench.stop()}ms to mount the database`, 'main_output');

    // Run a query without reading the results
    db.run("CREATE TABLE IF NOT EXISTS test (key, value);");
  };

  main();
</script>

<body>
  <p id="main_output"></p>
  <button onclick="globalBenchmark ? (clearTimeout(globalBenchmark) && (globalBenchmark = undefined)) : alert('Benchmark is not running')">Stop benchmark</button>
  <button onclick="globalBenchmark ? alert('Benchmark already running') : runBenchmark(db)">Start benchmark</button>
  <br />
  <p>Benchmark output:</p>
  <p id="output"></p>
</body>

</html>