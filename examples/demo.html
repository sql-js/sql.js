<meta charset="utf8" />
<html>
<script src='../dist/sqleet.js'></script>
<script>
  // helpers
  const log = (functionName, text, outputId = 'output') => document.getElementById(outputId).insertAdjacentHTML('beforeend', `${functionName ? `<b>${functionName}:</b> ` : ''}${text}<br />`);
  const timer = () => {
    const start = new Date();
    return {
      stop: () => {
        const end  = new Date();
        return end.getTime() - start.getTime();
      }
    }
  };

  /*[
  'mount',
  'saveChanges',
  'run',
  'exec',
  'each',
  'prepare',
  'export',
  'close',
  'wipe',
  'getRowsModified',
  'createFunction',
];*/

  let globalBenchmark;
  let db;

  async function runBenchmark(db) {
    var bench = timer();
    await db.run("INSERT INTO test VALUES (?,?), (?,?), (?,?), (?,?)", [
      'hello',
      'world',
      Math.random(),
      Math.random(),
      1,
      2,
      new Uint8Array(50),
      new Uint8Array(25)
    ]);
    log('db.run', `Took ${bench.stop()}ms to add 1 entry using`);

    var bench = timer();
      for (let i = 0; i < 250; i++) {
        await db.run("INSERT INTO test VALUES (?,?), (?,?), (?,?), (?,?)", [
          'hello',
          'world',
          Math.random(),
          Math.random(),
          1,
          2,
          new Uint8Array(50),
          new Uint8Array(25)
        ]);
      }
      log('db.run', `Took ${bench.stop()}ms to add 1000 entries using`);

      var bench = timer();
      console.log(await db.exec('SELECT * FROM test;'));
      log('db.exec', `Took ${bench.stop()}ms to get the rows in the test table`);

      var bench = timer();
      await db.saveChanges();
      log('db.saveChanges', `Took ${bench.stop()}ms to save the changes`);

      // Prepare a statement
      var bench = timer();
      const statement = await db.prepare('SELECT * FROM test');
      console.log(statement)
      while (statement.step()) {
        const row = statement.getAsObject();
        //console.log('Found a row: ' + JSON.stringify(row));
      }
      log('db.prepare', `Took ${bench.stop()}ms to get the rows in the test table`);

      log(undefined, '');
      globalBenchmark = setTimeout(async () => await runBenchmark(db), 2000);
  }

  async function main() {
    // We must specify this locateFile function if we are loading a wasm file from anywhere other than the current html page's folder.
    var bench = timer();
    db = new sqleet.DatabaseWorkerSender({key: 'supersecurepassword'}, 'aaaaa');
    log('constructor', `Took ${bench.stop()}ms to call the constructor`, 'main_output');

    var bench = timer();
    await db.mount();
    log('db.mount', `Took ${bench.stop()}ms to mount the database`, 'main_output');

    // Run a query without reading the results
    await db.run("CREATE TABLE IF NOT EXISTS test (key, value);");
  };

  const toggleButtons = () => {
    const start = document.getElementById('start');
    const stop = document.getElementById('stop');

    if (start.getAttribute('disabled') === 'disabled') {
      start.removeAttribute('disabled');
    } else {
      start.setAttribute('disabled', 'disabled');
    }

    if (stop.getAttribute('disabled') === 'disabled') {
      stop.removeAttribute('disabled');
    } else {
      stop.setAttribute('disabled', 'disabled');
    }
  };
  const startBenchmark = () => {
    if (!globalBenchmark) {
      document.getElementById('container').style.display = 'block';
      document.getElementById('output').innerHTML = '';
      runBenchmark(db);
    }
  };
  const stopBenchmark = () => {
    if (globalBenchmark) {
      clearTimeout(globalBenchmark);
      globalBenchmark = undefined;
    }
  };
  
  window.onload = () => main();
</script>

<body>
  <p id="main_output"></p>
  <button id="stop" disabled="disabled" onclick="stopBenchmark(); toggleButtons();">Stop benchmark</button>
  <button id="start" onclick="startBenchmark(); toggleButtons();">Start benchmark</button>
  <div id="container" style="display: none">
    <p>Benchmark output:</p>
    <p id="output"></p>
  </div>
</body>

</html>